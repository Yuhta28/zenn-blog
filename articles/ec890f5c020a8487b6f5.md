---
title: "credstashã‚’ç”¨ã„ã¦Apacheã®SSLç§˜å¯†éµã®ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºå•ã„åˆã‚ã›ç„¡è¦–ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ãŸ"
emoji: "ğŸ"
type: "tech"
topics: ["aws", "apache", "sslè¨¼æ˜æ›¸"]
published: true
---

# èƒŒæ™¯
SSLè¨¼æ˜æ›¸ã‚’å…¥ã‚Œã¦ã„ã‚‹Apacheã‚’å†èµ·å‹•ã—ãŸå ´åˆã€ç§˜å¯†éµã®ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã®å…¥åŠ›ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚
æ‰‹å‹•å†èµ·å‹•ãªã‚‰äººã®æ‰‹ã§ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã™ã‚Œã°ã‚ˆã„ã®ã§ã™ãŒã€ãƒãƒƒãƒå‡¦ç†ãªã©ã§Apacheã®å†èµ·å‹•ã‚’è‡ªå‹•ã§è¡Œãªã†å ´åˆã¯é€”ä¸­ã§å¤±æ•—ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
è§£æ±ºæ–¹æ³•ã¨ã—ã¦ã¯ã€ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è§£é™¤ã—ãŸç§˜å¯†éµã‚’é…ç½®ã™ã‚‹ã‹ã€[SSLPassPhraseDialog](https://httpd.apache.org/docs/current/mod/mod_ssl.html#sslpassphrasedialog)ã¨ã„ã†Apacheã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–å†…ã«`exec:/etc/httpd/conf.d/passphrase.sh`ã¨æ›¸ãã€ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è¡¨ç¤ºã•ã›ã‚‹ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¾ã›ã‚‹ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚

```bash:passphrase.sh
#!/bin/sh
echo 'ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º'
```

ã¨ã¯è¨€ãˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ä¸å®‰ãªé¢ãŒã‚ã‚Šã¾ã™ã®ã§ã€credstashã¨AWSãƒªã‚½ãƒ¼ã‚¹ã®KMSã‚’ä½¿ã†ã“ã¨ã§ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºå•é¡Œã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

# credstashã«ã¤ã„ã¦
credstashã¨ã¯ã€èªè¨¼æƒ…å ±ã®ç®¡ç†ãŠã‚ˆã³å…±æœ‰ã‚·ã‚¹ãƒ†ãƒ ã¨GitHubã®READMEã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://github.com/fugue/credstash
ä½¿ã„æ–¹ã¨ã—ã¦ã¯ã€èªè¨¼æƒ…å ±ã‚’AWSã®KMS(Key Management Service)ã‚’ç”¨ã„ã¦æš—å·åŒ–ã—ã€éµã¨èªè¨¼æƒ…å ±ã®çµ„ã¿åˆã‚ã›ã‚’DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ã™ã‚‹ã¨ã„ã£ãŸã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

# äº‹å‰æº–å‚™
credstashã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å‰ã«æš—å·åŒ–ã«ä½¿ç”¨ã™ã‚‹KMSã®ã‚­ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
KMSã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‹ã‚‰ã‚«ã‚¹ã‚¿ãƒãƒ¼ç®¡ç†å‹ã®ã‚­ãƒ¼ã‚’é¸æŠã—ã€ã‚­ãƒ¼ã®ä½œæˆã‚’é¸æŠã—ã¾ã™ã€‚
![](/images/credstash-apache-restart/image1.png)
è¨­å®šã«ã¤ã„ã¦ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®éƒ¨åˆ†ã¯**credstash**ã¨ã—ã¾ã™ã€‚
![](/images/credstash-apache-restart/image2.png)
ã‚­ãƒ¼ã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸã‚‰credstashã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¸ç§»ã‚Šã¾ã™ã€‚

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¨åˆæœŸè¨­å®š
pipã‚’ç”¨ã„ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
`pip install credstash`
ã¯ã˜ã‚ã¦credstashã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€`credstash setup`ã§DynamoDBã«credential-storeã¨ã„ã†ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
![](/images/credstash-apache-restart/image3.png)

æ¬¡ã«éµã¨èªè¨¼æƒ…å ±ã‚’DBã¸ç™»éŒ²ã™ã‚‹ãŸã‚ã«IAMã®æ¨©é™ã‚’è¨­å®šã—ã¾ã™ã€‚
GitHubã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã®IAMãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¦IAMãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã€‚

```json:secret-writer
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": [
        "kms:GenerateDataKey"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:kms:ap-northeast-1:AWSACCOUNTID:key/KEY-GUID"
    },
    {
      "Action": [
        "dynamodb:PutItem"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:dynamodb:ap-northeast:AWSACCOUNTID:table/credential-store"
    }
  ]
}
```

```json:secret-reader
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": [
        "kms:Decrypt"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:kms:ap-northeast-1:AWSACCOUNTID:key/KEY-GUID"
    },
    {
      "Action": [
        "dynamodb:GetItem",
        "dynamodb:Query",
        "dynamodb:Scan"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:dynamodb:ap-northeast-1:AWSACCOUNTID:table/credential-store"
    }
  ]
}
```

`AWSACCOUNTID`ã¨`KEY-GUID`ã®ç®‡æ‰€ã¯å„ã€…ã®æ•°å€¤ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚(KEY-GUIDã¯KMSã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼IDã®ã“ã¨ã§ã™)
ã¾ãŸ`credstash setup`ã§DynamoDBã®ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã«å¤±æ•—ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®IAMãƒãƒªã‚·ãƒ¼ã‚‚IAMãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒã—ã¦ãã ã•ã„ã€‚

```json:Setup
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
                "dynamodb:CreateTable",
                "dynamodb:DescribeTable"
            ],
            "Effect": "Allow",
            "Resource": "arn:aws:dynamodb:ap-northeast-1:<ACCOUNT NUMBER>:table/credential-store"
        },
        {
            "Action": [
                "dynamodb:ListTables"
            ],
            "Effect": "Allow",
            "Resource": "*"
        }
    ]
}
```

# ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã®æš—å·åŒ–
putã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’æš—å·åŒ–ã—ã¦DynamoDBã«ä¿å­˜ã—ã¾ã™ã€‚
`credstash -r ap-northeast-1 put --key alias/credstash "ä»»æ„ã®èªè¨¼æƒ…å ±å" "ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º"`
ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’apache_passphraseã¨è¨­å®šã—ã¾ã—ãŸã‚‰ã€ã“ã®ã‚ˆã†ã«DynamoDBã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
![](/images/credstash-apache-restart/image4.png)

## ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã®å¾©å·
å¾©å·ã¯getã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
`credstash -r ap-northeast-1 get "ä»»æ„ã®èªè¨¼æƒ…å ±å"`
# Apacheå´ã§èª­ã¿è¾¼ã¿
å†’é ­ã®`passphrase.sh`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¾ã™ã€‚

```bash:passphrase.sh
#!/bin/sh
Apache_Pass=`credstash -r ap-northeast-1 get apache_passphrase`

echo "$Apache_Pass"
```

Apacheã‚’å†èµ·å‹•ã—ã€ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’èã‹ã‚Œã‚‹ã“ã¨ãªãèµ·å‹•ã§ãã¾ã—ãŸã‚‰æˆåŠŸã§ã™ã€‚

# å¼•ã£ã‹ã‹ã‚Šãƒã‚¤ãƒ³ãƒˆ
å®Ÿã¯å¼Šç¤¾ã®ç’°å¢ƒã§ã€ä¸Šè¨˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§Apacheã‚’å†èµ·å‹•ã—ã¦ã‚‚credstashãŒæ©Ÿèƒ½ã›ãšã€å†èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚
Apacheã‚’å‹•ã‹ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ã®PythonãŒ2.6ç³»ã§ã—ãŸã€‚
READMEã«è¨˜è¼‰ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸãŒã€2ç³»ã§ã™ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããªã„å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã—ãŸã®ã§ã€pyenvã‚’ç”¨ã„ã¦Pythonã‚’3.6ç³»ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚
ãã®æ™‚ã«ç’°å¢ƒå¤‰æ•°å›ã‚Šã§å•é¡ŒãŒã‚ã£ãŸã®ã‹ã€èµ·å‹•ã§ããªã„ã¨ã„ã†å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚
å›é¿æ–¹æ³•ã¨ã—ã¦ã€`passphrase.sh`ã®ä¸­èº«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ãŸã‚‰credstashãŒå‹•ãã€Apacheã®å†èµ·å‹•ã«æˆåŠŸã—ã¾ã—ãŸã€‚

```bash:passphrase.sh
#!/bin/sh
Apache_Pass=`/root/.pyenv/shims/credstash -r ap-northeast-1 get apache_passphrase`

echo "$Apache_Pass"
```
# æ‰€æ„Ÿ
Apacheã§ã®SSLç§˜å¯†éµã«ã‚ˆã‚‹ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºå•é¡Œã¯ãƒãƒƒãƒˆä¸Šã§ã‚‚ã€ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºãã®ã‚‚ã®ã‚’è§£é™¤ã™ã‚‹ã‹ç›´æ¥ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’åŸ‹ã‚è¾¼ã‚“ã§èª­ã¿è¾¼ã‚€ã—ã‹ãªã‹ã£ãŸã®ã§ã€ã“ã‚Œã‚’ä½¿ãˆã°ã‚ˆã‚Šã‚»ã‚­ãƒ¥ã‚¢ãªApacheæ§‹ç¯‰ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã®ã§ã€çš†ã•ã‚“ã‚‚ãœã²ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ã€‚
credstashã¯Pythonè£½ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã§ã™ãŒã€Goã‚„Rubyãªã©ã§ä½œã‚‰ã‚ŒãŸã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ã®ã§ã€è‡ªèº«ã®å¥½ã¿ã®è¨€èªã‚’é¸æŠã™ã‚‹ã®ã‚‚ã®è‰¯ã„ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
# ãŠã¾ã‘ã€€2020/7/24è¿½è¨˜
nginxã§ã¯ã©ã®ã‚ˆã†ã«è¡Œãªãˆã°ã‚ˆã„ã®ã‹é¡ä¼¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒãªã„ã‹èª¿ã¹ã¾ã—ãŸãŒä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’è¨˜è¼‰ã™ã‚Œã°åŒã˜ã‚ˆã†ã«ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ç„¡è¦–ã—ã¦ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚
[ssl_password_file](http://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_password_file)
å°‘ã—ã ã‘SSLPassPhraseDialogã¨ã¯è¨˜æ³•ãŒç•°ãªã‚Šã¾ã™ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

```nginx:nginx.conf
http {
    ssl_password_file /etc/nginx/conf.d/passphrase.sh;

    server {
        server_name www1.example.com;
        ssl_certificate_key /etc/keys/first.key;
    }

    server {
        server_name www2.example.com;

        # named pipe can also be used instead of a file
        ssl_password_file /etc/keys/fifo;
        ssl_certificate_key /etc/keys/second.key;
    }
}
```

```bash:passphrase.sh
#!/bin/bash

Nginx_Pass=`/root/.pyenv/shims/credstash get nginx_pass`

echo "$Nginx_Pass"
```

![](/images/credstash-apache-restart/image5.png)
nginxã§ã‚‚SSLé€šä¿¡ãŒã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

### LTè³‡æ–™
ã“ã®è¨˜äº‹ã‚’åŸºã«ã—ãŸLTã‚’è¡Œãªã„ã¾ã—ãŸã®ã§ã€è³‡æ–™ã‚’ç½®ã„ã¦ãŠãã¾ã™ã€‚
@[speakerdeck](abace6aafdf244d18318995bdd2fbc12)