---
title: "Ansible Moleculeã¨GitHub Actionsã§CI/CDã‚’ä½“é¨“ã—ã¦ã¿ãŸ"
emoji: "ğŸ"
type: "tech"
topics: ["ansible", "githubactions", "ci", "molecule"]
published: true
---

# æ¦‚è¦
ä»¥å‰Moleculeã‚’ä½¿ã£ã¦Roleã®ãƒ†ã‚¹ãƒˆã‚’ã—ã¦ã¿ãŸè¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚
(https://note.com/tar28/n/n0878cd660c4a)
ä»Šå›ã¯ãã®æ™‚ã«ä½¿ã£ãŸRoleã‚’åŸºã«GitHub Actionsã«ã‚ˆã‚‹CI/CDã€ãƒ†ã‚¹ãƒˆã®è‡ªå‹•åŒ–ã‚’è¡Œã£ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚
# Moleculeã«ã¤ã„ã¦
æ”¹ã‚ã¦ã®èª¬æ˜ã«ãªã‚Šã¾ã™ãŒã€Moleculeã¯Ansible Roleã®ãƒ†ã‚¹ãƒˆã‚’æ”¯æ´ã—ã¦ãã‚Œã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
(https://molecule.readthedocs.io/en/latest/)
Moluculeã¯Ansibleã®æœ€æ–°å®‰å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ä¸€å€‹å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚
(2020/10ç¾åœ¨ã®Ansibleã®æœ€æ–°å®‰å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯2.9ç³»ãªãŸã‚ã€2.8ç³»ã¾ã§ã‚µãƒãƒ¼ãƒˆå¯¾è±¡ã§ã™)
`molecule test`ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€æ§‹æ–‡è¦ç´„ã®ãƒã‚§ãƒƒã‚¯ã‹ã‚‰ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒã®æ§‹ç¯‰ã€ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå†…ã§ã®Roleã®å®Ÿè¡Œã€ãƒ†ã‚¹ãƒˆãŒçµ‚äº†ã—ãŸé–‹ç™ºç’°å¢ƒã®ç ´æ£„ã¾ã§ã‚’è¡Œã£ã¦ãã‚Œã‚‹ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
# GitHub Actionsã«ã¤ã„ã¦
GitHub Actionsã¯GitHubç¤¾ãŒæä¾›ã™ã‚‹CI/CDãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
(https://github.co.jp/features/actions)
GitHubã®ãƒªãƒã‚¸ãƒˆãƒªã«å¯¾ã—ã¦ã€ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã‚Šãƒ—ãƒ«ãƒªã‚¯ã—ãŸã‚Šã™ã‚‹ã¨ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒ“ãƒ«ãƒ‰ã€ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ãªã©ã‚’è‡ªå‹•ã§è¡Œã£ã¦ãã‚Œã¾ã™ã€‚
### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
GitHub Actionsã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã„ã†å˜ä½ã§ä¸€é€£ã®å‡¦ç†ã‚’è‡ªå‹•åŒ–ã—ã¾ã™ã€‚
ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ãƒ“ãƒ«ãƒ‰ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ãªã©ã‚’å‡¦ç†ã‚’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã—ã¦è‡ªå‹•åŒ–ã§ãã¾ã™ã€‚ã¾ãŸGitHub Actionsã¯Issueã‚„ãƒ—ãƒ«ãƒªã‚¯ãŒç™ºè¡Œã•ã‚ŒãŸæ™‚ã«Slackã¸é€šçŸ¥ã™ã‚‹ä½œæ¥­ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã—ã¦è‡ªå‹•åŒ–ã§ãã¾ã™ã€‚
### ã‚¤ãƒ™ãƒ³ãƒˆ
ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã•ã›ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã«ãªã‚‹ã‚‚ã®ã‚’ã‚¤ãƒ™ãƒ³ãƒˆã¨å‘¼ã³ã¾ã™ã€‚ä¾‹ã¨ã—ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ã‚³ãƒŸãƒƒãƒˆã®ãƒ—ãƒƒã‚·ãƒ¥ã€ãƒ—ãƒ«ãƒªã‚¯ä½œæˆã€ã‚¿ã‚°ãƒ»ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆãªã©ãŒã‚ã‚Šã¾ã™ã€‚
### ã‚¸ãƒ§ãƒ–
ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯1ã¤ä»¥ä¸Šã®ã‚¸ãƒ§ãƒ–ã§æ§‹æˆã•ã‚Œã¦ãŠã‚Šã€ã‚¸ãƒ§ãƒ–ã®ä¸­èº«ãŒä¸€é€£ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚è¤‡æ•°ã®ã‚¸ãƒ§ãƒ–ã‚’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã€åŒæ™‚ä¸¦è¡Œã®å®Ÿè¡Œã‚„ã€Aã‚¸ãƒ§ãƒ–ãŒå®Œäº†ã—ãŸã‚‰Bã‚¸ãƒ§ãƒ–ã‚’èµ·å‹•ã™ã‚‹ã¨ã„ã£ãŸä¾å­˜é–¢ä¿‚ã®è¨­å®šã‚‚è¡Œãˆã¾ã™ã€‚
### ã‚¹ãƒ†ãƒƒãƒ—
ã‚¸ãƒ§ãƒ–ã¯1ã¤ä»¥ä¸Šã®ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ãŠã‚Šã€ã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã‚‹å€‹ã€…ã®ã‚¿ã‚¹ã‚¯ã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
### ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå®Ÿéš›ã®å‡¦ç†ã‚’ã¾ã¨ã‚ãŸGitHub Actionsã®æœ€å°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
ç‹¬è‡ªã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€GitHubå…¬å¼ã«ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚‚ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚
### ãƒ©ãƒ³ãƒŠãƒ¼
ãƒ©ãƒ³ãƒŠãƒ¼ã¯ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®GitHubãŒç”¨æ„ã—ã¦ã„ã‚‹ä»®æƒ³ç’°å¢ƒã§ã™ã€‚ç¾åœ¨ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ä»®æƒ³ç’°å¢ƒã¯
- Ubuntu
- Windows
- Mac

ä»¥ä¸Š3ã¤ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚(ãã‚Œãã‚Œæœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»¥å¤–ã‚‚ã¡ã‚ã‚“ä½¿ç”¨å¯èƒ½ã€‚RedHatç³»ã¯æ®‹å¿µãªãŒã‚‰ãªã„ã‚ˆã†ã§ã™ã€‚)
# ã‚„ã‚‹ã“ã¨
ä»¥å‰ã®[è¨˜äº‹](https://note.com/tar28/n/n0878cd660c4a)ã§ä½œæˆã—ãŸãƒªãƒã‚¸ãƒˆãƒªã«GitHub Actionsã‚’å°å…¥ã—ã¦ã€ãƒ†ã‚¹ãƒˆã®è‡ªå‹•åŒ–ã‚’è¡Œã„ã¾ã™ã€‚
ä½¿ã†ãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ã§ã™ã€‚
https://github.com/Yuhta28/ansible-Molecule
ã¾ãŸãƒ†ã‚¹ãƒˆã®å†…å®¹è‡ªä½“ã¯Software Design2020å¹´6æœˆå·ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹å˜ç´”ãªã‚‚ã®ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã¾ã™ã€‚(https://gihyo.jp/magazine/SD/archive/2020/202006)
# ãƒ†ã‚¹ãƒˆæº–å‚™
ã¾ãšã¯Moleculeã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ã¾ã™
åŸºæœ¬çš„ã«ã¯[å…¬å¼ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://molecule.readthedocs.io/en/latest/installation.html)é€šã‚Šé€²ã‚ã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚å‰ææ¡ä»¶ã¨ã—ã¦ã€Ansibleã¨Python3ç³»ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
` pip install --user "molecule[docker,lint]"`
pipãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã•ã‚Œã¾ã—ãŸã‚‰ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹æˆã‚’ä½œæˆã—ã¾ã™ã€‚

```
$ molecule --version
molecule 3.1.5
    ansible:2.9.13 python:3.8
    delegated:3.1.5 from molecule
    docker:0.2.4 from molecule_docker
    
$ molecule init role testmol
--> Initializing new role testmol...
Initialized role in /home/yuta/Desktop/work/ansible/molecule/testmol successfully.
$ tree
.
â”œâ”€â”€ README.md
â”œâ”€â”€ defaults
â”‚Â Â  â””â”€â”€ main.yml
â”œâ”€â”€ files
â”œâ”€â”€ handlers
â”‚Â Â  â””â”€â”€ main.yml
â”œâ”€â”€ meta
â”‚Â Â  â””â”€â”€ main.yml
â”œâ”€â”€ molecule
â”‚Â Â  â””â”€â”€ default
â”‚Â Â      â”œâ”€â”€ INSTALL.rst
â”‚Â Â      â”œâ”€â”€ converge.yml
â”‚Â Â      â”œâ”€â”€ create.yml
â”‚Â Â      â”œâ”€â”€ destroy.yml
â”‚Â Â      â”œâ”€â”€ molecule.yml
â”‚Â Â      â””â”€â”€ verify.yml
â”œâ”€â”€ tasks
â”‚Â Â  â””â”€â”€ main.yml
â”œâ”€â”€ templates
â”œâ”€â”€ tests
â”‚Â Â  â”œâ”€â”€ inventory
â”‚Â Â  â””â”€â”€ test.yml
â””â”€â”€ vars
    â””â”€â”€ main.yml

10 directories, 14 files
```

`molecule init role ãƒ­ãƒ¼ãƒ«å`ã§ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ­ãƒ¼ãƒ«åã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã€ãã®ç›´ä¸‹ã«moleculeã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã™ã€‚
ã“ã®æ™‚`molecule/default`é…ä¸‹ã«`create.yml`ã¨`destory.yml`ãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã®æ¤œè¨¼ã§ã¯ä½¿ã‚ãªã„ä¸Šã€æ”¾ç½®ã—ãŸã¾ã¾`molecule test`ã‚’å®Ÿè¡Œã—ã¾ã™ã¨ãƒ†ã‚¹ãƒˆå‹•ä½œãŒä¸Šæ‰‹ãã„ã‹ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã®ã§ã€å‰Šé™¤ã—ã¦ãŠãã¾ã™ã€‚(ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ãŒCentOS 8ã®ã¨ãã¯ã“ã®2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä½œæˆã•ã‚Œã¦ã„ãªã‹ã£ãŸã®ã§ã™ãŒã€OSã«ã‚ˆã‚‹ã‚‚ã®ãªã®ã‹Moleculeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ãŒåŸå› ãªã®ã‹ã¯ã„ã¾ã„ã¡ç†ç”±ãŒã‚ˆãã‚ã‹ã£ã¦ã„ã¾ã›ã‚“)
#### 2020/11/21è¿½è¨˜
ä¸Šè¨˜ã®ä»¶ã«ã¤ã„ã¦Teratailã§è³ªå•ã—ãŸæ‰€ã€Moleculeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã«ã‚ˆã‚‹ã‚‚ã®ã¨ã‚ã‹ã‚Šã¾ã—ãŸã€‚
> moleculeã¯3.1.0(Î±ç‰ˆå«ã‚€)ã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‰ãƒ©ã‚¤ãƒãŒdelegatedã«ãªã£ãŸã®ã§ã€æœ€æ–°ç‰ˆã ã¨è‡ªå‹•çš„ã« `create.yml` ã¨ `destroy.yml` ãŒä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

(https://teratail.com/questions/301543)

`molecule`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®ãŸã‚ã®ç’°å¢ƒå®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ†ã‚¹ãƒˆé …ç›®ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã‚’é…ç½®ã—ã¾ã™ã€‚`molecule/default/molecule.yml`ã®ä¸­èº«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¾ã™ã€‚

```yml
---
dependency:
  name: galaxy
driver:
  name: docker
platforms:
  - name: instance1
    image: docker.io/centos:7
    pre_build_image: true
    privileged: True
    command: /sbin/init

  - name: instance2
    image: docker.io/centos:8
    pre_build_image: true
    privileged: True
    command: /sbin/init

provisioner:
  name: ansible
verifier:
  name: ansible
```

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç”¨ã®CentoS7,8ã®Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ã¾ã™ã€‚
æ¬¡ã«ã€`tasks/main.yml`ã«ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨ãªã‚‹ã‚¿ã‚¹ã‚¯ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

```yml
---
# tasks file for testmol
- name: install httpd package
  yum:
    name: httpd
    state: latest

- name: start httpd
  systemd:
    name: httpd
    state: started
    enabled: yes
```
ã”è¦§ã®é€šã‚Šã€å†…å®¹ã¨ã—ã¦ã¯Apacheã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€èµ·å‹•ã—ã¦ã„ã‚‹ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚ã“ã®ã‚¿ã‚¹ã‚¯ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’`molecule/default/verify.yml`ã«è¨˜è¼‰ã—ã¾ã™ã€‚
```yml
---
# This is httpd install playbook to execute Ansible tests.

- name: Verify
  hosts: all
  tasks:
  - ignore_errors: yes
    block:
    - name: httpdãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å­˜åœ¨ã‚’ç¢ºèªã™ã‚‹
      yum:
        list: httpd
      register: result_rpm

    - name: httpdãƒ—ãƒ­ã‚»ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      shell: ps -ef | grep http[d]
      register: result_proc

    - name: httpdã‚µãƒ¼ãƒ“ã‚¹ãŒè‡ªå‹•èµ·å‹•ã«ãªã£ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹
      shell: systemctl is-enabled httpd
      register: result_enabled

  - name: çµæœã‚’ã¾ã¨ã‚ã¦ç¢ºèªã™ã‚‹
    assert:
      that: "{{ result.failed == false }}"
    loop:
      - "{{ result_rpm }}"
      - "{{ result_proc }}"
      - "{{ result_enabled }}"
    loop_control:
      loop_var: result
```

ã“ã‚Œã§ãƒ†ã‚¹ãƒˆã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸã®ã§ã€`molecule test`ã§å®Ÿè¡Œã—ã¾ã™ã€‚

```
$ molecule test
--> Test matrix
    
â””â”€â”€ default
    â”œâ”€â”€ dependency
    â”œâ”€â”€ lint
    â”œâ”€â”€ cleanup
    â”œâ”€â”€ destroy
    â”œâ”€â”€ syntax
    â”œâ”€â”€ create
    â”œâ”€â”€ prepare
    â”œâ”€â”€ converge
    â”œâ”€â”€ idempotence
    â”œâ”€â”€ side_effect
    â”œâ”€â”€ verify
    â”œâ”€â”€ cleanup
    â””â”€â”€ destroy
    
--> Scenario: 'default'
--> Action: 'dependency'
Skipping, missing the requirements file.
Skipping, missing the requirements file.
--> Scenario: 'default'
--> Action: 'lint'
--> Lint is disabled.
--> Scenario: 'default'
--> Action: 'cleanup'
Skipping, cleanup playbook not configured.
--> Scenario: 'default'
--> Action: 'destroy'
--> Sanity checks: 'docker'
    
    PLAY [Destroy] *****************************************************************
    
    TASK [Destroy molecule instance(s)] ********************************************
    changed: [localhost] => (item=instance1)
    changed: [localhost] => (item=instance2)
    
    TASK [Wait for instance(s) deletion to complete] *******************************
    ok: [localhost] => (item=None)
    ok: [localhost] => (item=None)
    ok: [localhost]
    
    TASK [Delete docker network(s)] ************************************************
    
    PLAY RECAP *********************************************************************
    localhost                  : ok=2    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
    
--> Scenario: 'default'
--> Action: 'syntax'
    
    playbook: /home/yuta/Desktop/work/docker/ansible-Molecule/testmol/molecule/default/converge.yml
--> Scenario: 'default'
--> Action: 'create'
    
    PLAY [Create] ******************************************************************
    
    TASK [Log into a Docker registry] **********************************************
    skipping: [localhost] => (item=None) 
    skipping: [localhost] => (item=None) 
    
    TASK [Check presence of custom Dockerfiles] ************************************
    ok: [localhost] => (item=None)
    ok: [localhost] => (item=None)
    ok: [localhost]
    
    TASK [Create Dockerfiles from image names] *************************************
    skipping: [localhost] => (item=None) 
    skipping: [localhost] => (item=None) 
    
    TASK [Discover local Docker images] ********************************************
    ok: [localhost] => (item=None)
    ok: [localhost] => (item=None)
    ok: [localhost]
    
    TASK [Build an Ansible compatible image (new)] *********************************
    skipping: [localhost] => (item=molecule_local/docker.io/centos:7) 
    skipping: [localhost] => (item=molecule_local/docker.io/centos:8) 
    
    TASK [Create docker network(s)] ************************************************
    
    TASK [Determine the CMD directives] ********************************************
    ok: [localhost] => (item=None)
    ok: [localhost] => (item=None)
    ok: [localhost]
    
    TASK [Create molecule instance(s)] *********************************************
    changed: [localhost] => (item=instance1)
    changed: [localhost] => (item=instance2)
    
    TASK [Wait for instance(s) creation to complete] *******************************
    changed: [localhost] => (item=None)
    FAILED - RETRYING: Wait for instance(s) creation to complete (300 retries left).
    changed: [localhost] => (item=None)
    changed: [localhost]
    
    PLAY RECAP *********************************************************************
    localhost                  : ok=5    changed=2    unreachable=0    failed=0    skipped=4    rescued=0    ignored=0
    
--> Scenario: 'default'
--> Action: 'prepare'
Skipping, prepare playbook not configured.
--> Scenario: 'default'
--> Action: 'converge'
    
    PLAY [Converge] ****************************************************************
    
    TASK [Gathering Facts] *********************************************************
    ok: [instance2]
    ok: [instance1]
    
    TASK [Include testmol] *********************************************************
    
    TASK [testmol : install httpd package] *****************************************
    changed: [instance2]
    changed: [instance1]
    
    TASK [testmol : start httpd] ***************************************************
    changed: [instance2]
    changed: [instance1]
    
    PLAY RECAP *********************************************************************
    instance1                  : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    instance2                  : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    
--> Scenario: 'default'
--> Action: 'idempotence'
Idempotence completed successfully.
--> Scenario: 'default'
--> Action: 'side_effect'
Skipping, side effect playbook not configured.
--> Scenario: 'default'
--> Action: 'verify'
--> Running Ansible Verifier
    
    PLAY [Verify] ******************************************************************
    
    TASK [Gathering Facts] *********************************************************
    ok: [instance2]
    ok: [instance1]
    
    TASK [httpdãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å­˜åœ¨ã‚’ç¢ºèªã™ã‚‹] ******************************************************
    ok: [instance2]
    ok: [instance1]
    
    TASK [httpdãƒ—ãƒ­ã‚»ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹] *************************************************
    changed: [instance2]
    changed: [instance1]
    
    TASK [httpdã‚µãƒ¼ãƒ“ã‚¹ãŒè‡ªå‹•èµ·å‹•ã«ãªã£ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹] **********************************************
    changed: [instance2]
    changed: [instance1]
    
    TASK [çµæœã‚’ã¾ã¨ã‚ã¦ç¢ºèªã™ã‚‹] *************************************************************
    ok: [instance1] => (item={'results': [{'envra': '0:httpd-2.4.6-93.el7.centos.x86_64', 'name': 'httpd', 'repo': 'base', 'epoch': '0', 'version': '2.4.6', 'release': '93.el7.centos', 'yumstate': 'available', 'arch': 'x86_64'}, {'envra': '0:httpd-2.4.6-93.el7.centos.x86_64', 'name': 'httpd', 'repo': 'installed', 'epoch': '0', 'version': '2.4.6', 'release': '93.el7.centos', 'yumstate': 'installed', 'arch': 'x86_64'}], 'failed': False, 'changed': False}) => {
        "ansible_loop_var": "result",
        "changed": false,
        "msg": "All assertions passed",
        "result": {
            "changed": false,
            "failed": false,
            "results": [
                {
                    "arch": "x86_64",
                    "envra": "0:httpd-2.4.6-93.el7.centos.x86_64",
                    "epoch": "0",
                    "name": "httpd",
                    "release": "93.el7.centos",
                    "repo": "base",
                    "version": "2.4.6",
                    "yumstate": "available"
                },
                {
                    "arch": "x86_64",
                    "envra": "0:httpd-2.4.6-93.el7.centos.x86_64",
                    "epoch": "0",
                    "name": "httpd",
                    "release": "93.el7.centos",
                    "repo": "installed",
                    "version": "2.4.6",
                    "yumstate": "installed"
                }
            ]
        }
    }
    ok: [instance2] => (item={'msg': '', 'results': [{'name': 'httpd', 'arch': 'x86_64', 'epoch': '0', 'release': '21.module_el8.2.0+494+1df74eae', 'version': '2.4.37', 'repo': '@System', 'nevra': '0:httpd-2.4.37-21.module_el8.2.0+494+1df74eae.x86_64', 'yumstate': 'installed'}, {'name': 'httpd', 'arch': 'x86_64', 'epoch': '0', 'release': '21.module_el8.2.0+494+1df74eae', 'version': '2.4.37', 'repo': 'AppStream', 'nevra': '0:httpd-2.4.37-21.module_el8.2.0+494+1df74eae.x86_64', 'yumstate': 'available'}], 'failed': False, 'changed': False}) => {
        "ansible_loop_var": "result",
        "changed": false,
        "msg": "All assertions passed",
        "result": {
            "changed": false,
            "failed": false,
            "msg": "",
            "results": [
                {
                    "arch": "x86_64",
                    "epoch": "0",
                    "name": "httpd",
                    "nevra": "0:httpd-2.4.37-21.module_el8.2.0+494+1df74eae.x86_64",
                    "release": "21.module_el8.2.0+494+1df74eae",
                    "repo": "@System",
                    "version": "2.4.37",
                    "yumstate": "installed"
                },
                {
                    "arch": "x86_64",
                    "epoch": "0",
                    "name": "httpd",
                    "nevra": "0:httpd-2.4.37-21.module_el8.2.0+494+1df74eae.x86_64",
                    "release": "21.module_el8.2.0+494+1df74eae",
                    "repo": "AppStream",
                    "version": "2.4.37",
                    "yumstate": "available"
                }
            ]
        }
    }
    ok: [instance1] => (item={'changed': True, 'end': '2020-11-03 07:59:36.635845', 'stdout': 'root         363       1  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       364     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       365     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       366     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       367     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       368     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND', 'cmd': 'ps -ef | grep http[d]', 'rc': 0, 'start': '2020-11-03 07:59:35.547485', 'stderr': '', 'delta': '0:00:01.088360', 'stdout_lines': ['root         363       1  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND', 'apache       364     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND', 'apache       365     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND', 'apache       366     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND', 'apache       367     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND', 'apache       368     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND'], 'stderr_lines': [], 'failed': False}) => {
        "ansible_loop_var": "result",
        "changed": false,
        "msg": "All assertions passed",
        "result": {
            "changed": true,
            "cmd": "ps -ef | grep http[d]",
            "delta": "0:00:01.088360",
            "end": "2020-11-03 07:59:36.635845",
            "failed": false,
            "rc": 0,
            "start": "2020-11-03 07:59:35.547485",
            "stderr": "",
            "stderr_lines": [],
            "stdout": "root         363       1  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       364     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       365     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       366     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       367     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       368     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND",
            "stdout_lines": [
                "root         363       1  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND",
                "apache       364     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND",
                "apache       365     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND",
                "apache       366     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND",
                "apache       367     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND",
                "apache       368     363  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND"
            ]
        }
    }
    ok: [instance2] => (item={'cmd': 'ps -ef | grep http[d]', 'stdout': 'root         404       1  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       429     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       431     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       432     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       433     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND', 'stderr': '', 'rc': 0, 'start': '2020-11-03 07:59:35.568724', 'end': '2020-11-03 07:59:35.587274', 'delta': '0:00:00.018550', 'changed': True, 'stdout_lines': ['root         404       1  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND', 'apache       429     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND', 'apache       431     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND', 'apache       432     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND', 'apache       433     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND'], 'stderr_lines': [], 'failed': False}) => {
        "ansible_loop_var": "result",
        "changed": false,
        "msg": "All assertions passed",
        "result": {
            "changed": true,
            "cmd": "ps -ef | grep http[d]",
            "delta": "0:00:00.018550",
            "end": "2020-11-03 07:59:35.587274",
            "failed": false,
            "rc": 0,
            "start": "2020-11-03 07:59:35.568724",
            "stderr": "",
            "stderr_lines": [],
            "stdout": "root         404       1  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       429     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       431     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       432     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND\napache       433     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND",
            "stdout_lines": [
                "root         404       1  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND",
                "apache       429     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND",
                "apache       431     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND",
                "apache       432     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND",
                "apache       433     404  0 07:58 ?        00:00:00 /usr/sbin/httpd -DFOREGROUND"
            ]
        }
    }
    ok: [instance1] => (item={'changed': True, 'end': '2020-11-03 07:59:39.966874', 'stdout': 'enabled', 'cmd': 'systemctl is-enabled httpd', 'rc': 0, 'start': '2020-11-03 07:59:38.881374', 'stderr': '', 'delta': '0:00:01.085500', 'stdout_lines': ['enabled'], 'stderr_lines': [], 'failed': False}) => {
        "ansible_loop_var": "result",
        "changed": false,
        "msg": "All assertions passed",
        "result": {
            "changed": true,
            "cmd": "systemctl is-enabled httpd",
            "delta": "0:00:01.085500",
            "end": "2020-11-03 07:59:39.966874",
            "failed": false,
            "rc": 0,
            "start": "2020-11-03 07:59:38.881374",
            "stderr": "",
            "stderr_lines": [],
            "stdout": "enabled",
            "stdout_lines": [
                "enabled"
            ]
        }
    }
    ok: [instance2] => (item={'cmd': 'systemctl is-enabled httpd', 'stdout': 'enabled', 'stderr': '', 'rc': 0, 'start': '2020-11-03 07:59:39.213457', 'end': '2020-11-03 07:59:39.235024', 'delta': '0:00:00.021567', 'changed': True, 'stdout_lines': ['enabled'], 'stderr_lines': [], 'failed': False}) => {
        "ansible_loop_var": "result",
        "changed": false,
        "msg": "All assertions passed",
        "result": {
            "changed": true,
            "cmd": "systemctl is-enabled httpd",
            "delta": "0:00:00.021567",
            "end": "2020-11-03 07:59:39.235024",
            "failed": false,
            "rc": 0,
            "start": "2020-11-03 07:59:39.213457",
            "stderr": "",
            "stderr_lines": [],
            "stdout": "enabled",
            "stdout_lines": [
                "enabled"
            ]
        }
    }
    
    PLAY RECAP *********************************************************************
    instance1                  : ok=5    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    instance2                  : ok=5    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    
Verifier completed successfully.
--> Scenario: 'default'
--> Action: 'cleanup'
Skipping, cleanup playbook not configured.
--> Scenario: 'default'
--> Action: 'destroy'
    
    PLAY [Destroy] *****************************************************************
    
    TASK [Destroy molecule instance(s)] ********************************************
    changed: [localhost] => (item=instance1)
    changed: [localhost] => (item=instance2)
    
    TASK [Wait for instance(s) deletion to complete] *******************************
    changed: [localhost] => (item=None)
    FAILED - RETRYING: Wait for instance(s) deletion to complete (300 retries left).
    changed: [localhost] => (item=None)
    changed: [localhost]
    
    TASK [Delete docker network(s)] ************************************************
    
    PLAY RECAP *********************************************************************
    localhost                  : ok=2    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
    
--> Pruning extra files from scenario ephemeral directory

```

# Moleculeã®å‹•ãã«ã¤ã„ã¦
Moleculeã¯`molecule test`ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã¨ãªã‚Šã€ã‚¹ãƒ†ãƒƒãƒ—ã¨ã„ã†å˜ä½ã§å‡¦ç†ãŒé †æ¬¡å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
ã‚¹ãƒ†ãƒƒãƒ—ã®å†…å®¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§é †æ¬¡å®Ÿè¡Œã•ã‚Œã€Roleã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚

| ã‚¹ãƒ†ãƒƒãƒ— | å®Ÿæ–½å†…å®¹ |
|:---------------|---------------------:|
| dependency     | ä¾å­˜é–¢ä¿‚ã‚’å‡¦ç†        |
| lint           | è¦ç´„ãƒã‚§ãƒƒã‚¯          |
| cleanup        | ç’°å¢ƒã®æƒé™¤            |
| destroy        | ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å‰Šé™¤      |
| syntax         | æ§‹æ–‡ãƒã‚§ãƒƒã‚¯          |
| create         | ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ§‹ç¯‰      |
| prepare        | ãƒ†ã‚¹ãƒˆã®å‰å‡¦ç†ã‚’å®Ÿè¡Œ  |
| converge       | Roleã®å®Ÿè¡Œ            |
| idempotence    | Roleã®å†å®Ÿè¡Œ         |
| side_effect    | ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®ãŸã‚ã®å‰¯ä½œç”¨ã‚’ç™ºç”Ÿã•ã›ã‚‹ |
| verify         | ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ        |
| clenup         | ç’°å¢ƒã®æƒé™¤          |
| destroy        | ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å‰Šé™¤    |
â€»å¼•ç”¨ SoftwareDesign 2020/6æœˆå·
(https://gihyo.jp/magazine/SD/archive/2020/202006)
ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰çµæœã¯defaultã¨ã„ã†ã‚·ãƒŠãƒªã‚ªã®ä¸­ã§å¿…è¦ãªã‚¹ãƒ†ãƒƒãƒ—ãŒé †æ¬¡å®Ÿè¡Œã•ã‚Œã¦ãŠã‚Šã¾ã™ã€‚
(ã‚¹ãƒ†ãƒƒãƒ—ã¯ã™ã¹ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã¯ãªãã€çœç•¥ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™)
ã“ã“ã¾ã§ã§Ansible Moleculeã§Roleã®ãƒ†ã‚¹ãƒˆã‚’è¡Œãˆã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
æ¬¡ã‹ã‚‰GitHub Actionsã«ã‚ˆã‚‹CI/CDã®å®Ÿè£…ã«å…¥ã‚ŠãŸã„ã¨æ€ã„ã¾ã™ã€‚
# GitHub Actionå°å…¥
GitHub Actionsã®å°å…¥ã¯GitHubã®ãƒªãƒã‚¸ãƒˆãƒªå†…ã«ã‚ã‚‹Actionsã‚¿ãƒ–ã‹ã‚‰æ–°è¦ã«ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚![](https://storage.googleapis.com/zenn-user-upload/ta287glhctuwpgxr6zo2a7y6qzdl)
GitHubå´ãŒç”¨æ„ã—ãŸã„ãã¤ã‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ã‚‰é©ã—ãŸã‚‚ã®ã‚’é¸ã¶ã“ã¨ã‚‚ã§ãã¾ã™ã—ã€è‡ªåˆ†ã§ä¸€ã‹ã‚‰ä½œæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
Ansible Moleculeã®å…¬å¼ã‚µã‚¤ãƒˆã«ã‚µãƒ³ãƒ—ãƒ«ãŒã‚ã‚Šã¾ã—ãŸã®ã§ã€ã“ã“ã§ã¯Simple workflowã‚’é¸æŠã—ã¦ä¸€ã‹ã‚‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚
(https://molecule.readthedocs.io/en/latest/ci.html#github-actions)
ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã¨ã€`.github/workflows/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œãã®ä¸­ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è¨­å®šã™ã‚‹YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¾ã™ã€‚![](https://storage.googleapis.com/zenn-user-upload/rht8euniiwjf37xyx7dbmrwjh9h9)
ã“ã“ã§ã¯ã€å…¬å¼ã‚µã‚¤ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æ¬¡ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

```yml
---
name: Molecule Test
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.6, 3.7]

    steps:
      - uses: actions/checkout@v2
        with:
          path: molecule_demo
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          sudo apt install docker
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
      - name: Test with molecule
        run: |
          molecule test
```

ã•ã¦ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã«ã¯ã„ãã¤ã‹ç§ã®ãƒªãƒã‚¸ãƒˆãƒªã«ããã‚ãªã„éƒ¨åˆ†ãŒã‚ã‚Šã¾ã™ã®ã§ã„ãã¤ã‹åˆã‚ã›ã¦ã„ãã¾ã™ã€‚ã¾ãšç§ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ©ãƒ³ãƒŠãƒ¼ã®ä¸­ã«å°å…¥ã—ãŸã„ã®ã§ã€gitã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãƒ©ãƒ³ãƒŠãƒ¼ç’°å¢ƒã§`git clone`ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚æ¬¡ã«ãƒ©ãƒ³ãƒŠãƒ¼ã«pipãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã®`requirements.txt`ãŒã‚ã‚Šã¾ã™ã®ã§ã€ç§ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚‚ç”¨æ„ã—ã¦ãŠãã¾ã™ã€‚

```
$ pip freeze > requirements.txt
$ tree
.
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt
â””â”€â”€ testmol
    â”œâ”€â”€ README.md
    â”œâ”€â”€ defaults
    â”‚Â Â  â””â”€â”€ main.yml
    â”œâ”€â”€ handlers
    â”‚Â Â  â””â”€â”€ main.yml
    â”œâ”€â”€ meta
    â”‚Â Â  â””â”€â”€ main.yml
    â”œâ”€â”€ molecule
    â”‚Â Â  â””â”€â”€ default
    â”‚Â Â      â”œâ”€â”€ INSTALL.rst
    â”‚Â Â      â”œâ”€â”€ converge.yml
    â”‚Â Â      â”œâ”€â”€ molecule.yml
    â”‚Â Â      â””â”€â”€ verify.yml
    â”œâ”€â”€ tasks
    â”‚Â Â  â””â”€â”€ main.yml
    â”œâ”€â”€ tests
    â”‚Â Â  â”œâ”€â”€ inventory
    â”‚Â Â  â””â”€â”€ test.yml
    â””â”€â”€ vars
        â””â”€â”€ main.yml

9 directories, 14 files
```

æœ€å¾Œã«`molecule test`ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œå ´æ‰€ã§ã™ãŒã€ã“ã‚Œã§ã™ã¨`testmol`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸€å€‹ä¸Šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œã—ã¦ãŠã‚Šã€å¤±æ•—ã—ã¾ã™ã®ã§`cd testmol`ã§ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã§ãã‚‹å ´æ‰€ã«ç§»å‹•ã—ã¾ã™ã€‚
ã“ã®çµæœä¿®æ­£ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒã“ã¡ã‚‰ã§ã™ã€‚

```yml
---
name: Molecule Test
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.7, 3.8]

    steps:
      - uses: actions/checkout@v2
        with:
          path: molecule_demo
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          sudo apt install git docker
          git clone -b Yuhta28-patch-2 https://github.com/Yuhta28/ansible-Molecule.git
          python3 -m pip install --upgrade pip
          python3 -m pip install -r ansible-Molecule/requirements.txt
      - name: Test with molecule
        run: |
          cd ansible-Molecule/testmol
          molecule test
```

ã“ã“ã¾ã§å®Œäº†ã—ã¾ã—ãŸã‚‰å³ä¸Šã®Start commitãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¬ãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™ã€‚
ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™ã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œãƒ†ã‚¹ãƒˆãŒèµ°ã‚Šã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/t576ec7wtoo1okmdkxsu5jm9v85q)
ã—ã°ã‚‰ãã—ãŸã‚‰ã€å‡¦ç†ãŒå®Œäº†ã—ãƒ†ã‚¹ãƒˆãŒç„¡äº‹ã«å®Œäº†ã™ã‚‹ã‹ã¨æ€ã‚ã‚Œã¾ã—ãŸã€‚
# ãƒ†ã‚¹ãƒˆå¤±æ•—
ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å‡¦ç†çµæœã‚’ç¢ºèªã—ã¾ã™ã¨ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã„ã¾ã—ãŸã€‚![](https://storage.googleapis.com/zenn-user-upload/2cfesd6rb0xa2iqkypwbor2i85yb)
GitHub Actionsã§ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œçµæœãƒ­ã‚°ã‚‚GitHubã‹ã‚‰ç¢ºèªã§ãã¾ã™ã®ã§ã€ä¸­èº«ã‚’è¦‹ã¦ã¾ã™ã¨Dockerã®èµ·å‹•ã«å¤±æ•—ã—ã¦ã„ã‚‹ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæœ‰ã‚Šã¾ã—ãŸã€‚![](https://storage.googleapis.com/zenn-user-upload/qf01j6k7ooevsbo836iqcgztqjqt)
ãã‚Œã§ä¸€ã¤æ°—ã«ãªã£ãŸã®ãŒã€Moleculeã®å…¬å¼ã‚µã‚¤ãƒˆã§ç´¹ä»‹ã•ã‚Œã¦ã„ãŸdockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã§ã™ã€‚`sudo apt install docker`ã¨è¨˜ã•ã‚Œã¦ã„ã¾ã™ãŒã€Dockerã®å…¬å¼ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã«ã‹ã‹ã‚Œã¦ã„ã‚‹Ubuntuä¸Šã§ã®Dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã¨ç•°ãªã£ã¦ã„ã¾ã™ã€‚(https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository)
ãªã®ã§ã€Dockerå…¬å¼ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã«å‰‡ã£ãŸæ–¹æ³•ã§Dockerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã«é–¢ã—ã¦ä¿®æ­£ã—ã¾ã—ãŸã€‚
ä¿®æ­£ã—ãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒã“ã¡ã‚‰ã§ã™ã€‚

```yml
---
name: Molecule Test
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.7, 3.8]

    steps:
      - uses: actions/checkout@v2
        with:
          path: molecule_demo
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          sudo apt install git apt-transport-https ca-certificates curl gnupg-agent software-properties-common
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
          sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
          sudo apt-get update
          sudo apt-get install docker-ce docker-ce-cli containerd.io
          git clone -b Yuhta28-patch-3 https://github.com/Yuhta28/ansible-Molecule.git
          python3 -m pip install --upgrade pip
          python3 -m pip install -r ansible-Molecule/requirements.txt
      - name: Test with molecule
        run: |
          cd ansible-Molecule/testmol
          molecule test
```

ã“ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã‚‚ã†ä¸€åº¦commitã—ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ°ã‚‰ã›ã‚‹ã¨å•é¡Œãªããƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ãŸã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/drk97whcnnr5874o8ayq1355lgma)

# æ‰€æ„Ÿ
Ansible Moduleã¨GitHub Actionsã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§CI/CDã®ä¸€ç«¯ã«ãµã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚GitHub Actionsã¯ã¾ã æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã§è³‡æ–™ã‚‚å°‘ãªã‹ã£ãŸã§ã™ãŒã€GitHubã¸ã‚³ãƒŸãƒƒãƒˆã€ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚Œã°ã™ãã«é–‹å§‹ã•ã‚ŒãŸã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ä¸Šã«ä½•ã‹ã—ã‚‰ã®ç”¨æ„ã™ã‚‹å¿…è¦ã‚‚ãªã„ã®ã§è§¦ã£ã¦ã¿ã¦ä¾¿åˆ©ãªä»£ç‰©ã ã¨æ€ã„ã¾ã—ãŸã€‚ä¼šç¤¾ã§ã¯Circle CIã‚’ä½¿ã£ã¦ã„ã¾ã™ã®ã§ã™ãã«å°å…¥ã™ã‚‹ã“ã¨ã¯ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ä»Šå¾Œã®çŸ¥è¦‹ã®ãŸã‚ã«è§¦ã£ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

### LTè³‡æ–™
ã“ã®è¨˜äº‹ã‚’åŸºã«ã—ãŸLTã‚’è¡Œã„ã¾ã—ãŸã®ã§è³‡æ–™ã‚’ç½®ã„ã¦ãŠãã¾ã™ã€‚
@[speakerdeck](4b8515368c5246a2b9707011786c3d82)