---
title: "ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯InSpecã‚’ã¨ã‚Šã‚ãˆãšè§¦ã£ã¦ã¿ãŸ"
emoji: "ğŸ"
type: "tech"
topics: ["centos", "test", "inspec"]
published: true
---

# æ¦‚è¦
å…ˆæ—¥ã€IBMãŒä¸»å‚¬ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ[ã€ŒEnterprise Server Meetupã€ã®ç¬¬2å›](https://enterprise-server.connpass.com/event/192584/)ãŒé–‹å‚¬ã•ã‚Œã¾ã—ãŸã€‚
ç¬¬2å›ã®ãƒ†ãƒ¼ãƒãŒã‚¤ãƒ³ãƒ•ãƒ©é‹ç”¨ãƒ»æ§‹ç¯‰ã®è‡ªå‹•åŒ–ã§ã€å€‹äººçš„ã«èˆˆå‘³ã®ã‚ã‚‹å†…å®¹ã§ã—ãŸã®ã§å‚åŠ ã—ã¦ã¿ã¾ã—ãŸã€‚
ãã®ä¸­ã§åˆã‚ã¦ç›®ã«ã—ãŸãƒ„ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã—ãŸã®ã§ã€æ—©é€Ÿè§¦ã£ã¦ã¿ã¾ã—ãŸã€‚
# InSpecã¨ã¯
æ§‹æˆç®¡ç†ãƒ„ãƒ¼ãƒ«Chefã®é–‹ç™ºã§çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹Chefç¤¾ãŒOSSã¨ã—ã¦Rubyã§é–‹ç™ºã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚
https://docs.chef.io/inspec/
ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦æœ‰åãªServerspecã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒ‘ã‚¤ã‚¢ã•ã‚Œã¦ãŠã‚Šã€äº’æ›æ€§ã¯ã‚‚ã¡ã‚ã‚“å¾Œç™ºã®åˆ©ç‚¹ã¨ã—ã¦AWSãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ã‚µãƒãƒ¼ãƒˆãŒè±Šå¯Œã§ã‚ã‚‹ãªã©ã®ç‚¹ãŒã‚ã’ã‚‰ã‚Œã¾ã™ã€‚
åˆã‚ã¦ä½¿ã„ã¾ã™ã®ã§ã€ã¾ãšã¯å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã®READMEã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦è©¦ã—ã¦ã¿ã¾ã™ã€‚
https://github.com/inspec/inspec#chef-inspec-inspect-your-infrastructure

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †
ä¸Šè¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªå†…ã«ç´¹ä»‹ã•ã‚ŒãŸæ‰‹é †ã§é€²ã‚ã¦ã„ãã¾ã™ã€‚ç’°å¢ƒã¯AlamaLinuxã‚’ä½¿ã„ã¾ã—ãŸã€‚
(CentOSã§ã‚‚ã‚‚ã¡ã‚ã‚“å¤§ä¸ˆå¤«ã§ã™ã€‚ãŸã¶ã‚“)
InSpecã¯Rubyã§è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã¾ãšã¯Rubyã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³2.6ä»¥ä¸Šã¨ã®ã“ã¨ï¼‰
yumãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã¨Rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„ã®ã§ã€rbenvã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
## Rubyã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †

```sh
# rbenvã¨ruby-buildã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ git clone https://github.com/sstephenson/rbenv.git ~/.rbenv
$ git clone https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build

# .bash_profileè¨­å®š
$ echo '# rbenv' >> ~/.bash_profile
$ echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bash_profile
$ echo 'eval "$(rbenv init -)"' >> ~/.bash_profile
$ exec $SHELL --login

# rubyã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ sudo dnf -y install bzip2 gcc openssl-devel readline-devel zlib-devel

# rbenvã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹rubyãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
$ rbenv install --list
2.6.7
2.7.3
3.0.1
jruby-9.2.17.0
mruby-3.0.0
rbx-5.0
truffleruby-21.1.0
truffleruby+graalvm-21.1.0

Only latest stable releases for each Ruby implementation are shown.
Use 'rbenv install --list-all / -L' to show all local versions.

# ruby 2.7ç³»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ rbenv install 2.7.3
$ rbenv global 2.7.3
$ ruby -v
ruby 2.7.3p183 (2021-04-05 revision 6847ee089d) [x86_64-linux]
```

## InSpecã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
$ curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P inspec
$ inspec -v
4.37.0
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã§ãã¾ã—ãŸã®ã§ã€ç¶šã„ã¦ç°¡å˜ãªãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```ruby:installed-apache.rb
describe package('httpd') do
  it { should be_installed }
end
```

ApacheãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã§å®Ÿè¡Œã™ã‚‹å ´åˆã€`inspec exec installed-apache.rb`ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```sh
$ inspec exec installed-apache.rb

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹å ´åˆ
Profile: tests from httpd.rb (tests from httpd.rb)
Version: (not specified)
Target:  local://

  System Package httpd
     âœ”  is expected to be installed

Test Summary: 1 successful, 0 failures, 0 skipped

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãªã„å ´åˆ
Profile: tests from installed-apache.rb (tests from installed-apache.rb)
Version: (not specified)
Target:  local://

  System Package httpd
     Ã—  is expected to be installed
     expected that `System Package httpd` is installed

Test Summary: 0 successful, 1 failure, 0 skipped
```

`describe.one`ã‚’ä½¿ã†ã“ã¨ã§è¤‡æ•°ã®æ¡ä»¶ã®ä¸­ã‹ã‚‰ä¸€ã¤æº€ãŸã›ã°å…¨ä½“ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã«ãªã‚‹ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æ›¸ãã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```ruby:a-or-b-test.rb
control 'or-test' do
  impact 1.0
  title 'This is a OR test Apache or Nginx'
  describe.one do
    describe package('httpd') do
      it { should be_installed }
    end
    describe package('nginx') do
      it { should be_installed }
    end
  end
end
```

```sh
$ inspec exec a-or-b-test.rb

Profile: tests from a-or-b-test.rb (tests from a-or-b-test.rb)
Version: (not specified)
Target:  local://

  âœ”  or-test: This is a OR test Apache or Nginx
     âœ”  System Package httpd is expected to be installed


Profile Summary: 1 successful control, 0 control failures, 0 controls skipped
Test Summary: 1 successful, 0 failures, 0 skipped
```

ãƒ­ãƒ¼ã‚«ãƒ«ä¸Šã§å®Ÿè¡Œã—ã¾ã—ãŸã®ã§ã€ä»Šåº¦ã¯ãƒªãƒ¢ãƒ¼ãƒˆå…ˆã§åŒã˜ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆãŒã§ãã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
ãƒªãƒ¢ãƒ¼ãƒˆå…ˆã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯-tã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒªãƒ¢ãƒ¼ãƒˆå…ˆãƒã‚·ãƒ³ã®æƒ…å ±ã‚’æŒ‡å®šã—ã¾ã™ã€‚
`inspec exec httpd.rb -t ssh://user@IPaddress -i pubkey`



```sh
$ inspec exec installed-apache.rb -t ssh://ec2-user@13.230.244.157 -i ~/.ssh/TokyoKeyPair.pem

Profile: tests from installed-apache.rb (tests from installed-apache.rb)
Version: (not specified)
Target:  ssh://ec2-user@13.230.244.157:22

  System Package httpd
     âœ”  is expected to be installed

Test Summary: 1 successful, 0 failures, 0 skipped
```

# æ‰€æ„Ÿ
InSpecã‚’ä½¿ã£ã¦ç°¡å˜ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ãŸã€‚
ä»Šå›å®Ÿæ–½ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã¯Serverspecã¨ã®å·®åˆ¥ç‚¹ã¯ã‚ã¾ã‚Šãªã„ã‚ˆã†ã«æ„Ÿã˜ã‚‰ã‚Œã¾ã™ãŒã€Chefç¤¾ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨InSpecã¯ã‚ˆã‚Šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£éƒ¨é–€ã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹ã¨æ˜è¨˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
> One of the key differences is that Chef InSpec targets more user groups. It is optimized for DevOps, Security, and Compliance professionals. 

https://docs.chef.io/inspec/inspec_and_friends/#how-is-chef-inspec-different-from-serverspec

ä»Šå¾Œã‚‚ä½¿ã„æ–¹ã‚’å­¦ã‚“ã§å®Ÿè·µã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

# å‚è€ƒæ–‡çŒ®
https://qiita.com/NaokiIshimura/items/ff04b6eaa40b33c4bea8

https://github.com/inspec/inspec#chef-inspec-inspect-your-infrastructure

https://docs.chef.io/inspec/inspec_and_friends/
