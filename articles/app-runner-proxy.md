---
title: "App Runnerで気になったところ"
emoji: "🐕"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS", "apprunner"]
published: false
---

:::message alert
この記事は結論がありません。調べてみましたが原因がわからなかったので詳しい人いましたらアドバイスいただけますと幸いです。
:::

# 背景
会社でDatadogによるモニタリング基盤の構築を実装しています。最初はメディアサーバーやDBを監視するためにエージェント起動用のEC2を用意してそこからサーバーへの外形監視やDB監視を構築していました。
ただ導入しているエージェントを動かすためだけにサーバーを用意するのものもったいなかったのでコンテナにDatadogエージェントを導入し、そこから起動するようにしました。
せっかくなので昨年リリースされたApp Runner[^1]でDatadogエージェントコンテナを構築してみました。
[^1]: https://aws.amazon.com/jp/apprunner/

![](/images/app-runner-proxy/image7.png)
*アーキテクチャ図*

App RunnerならECR[^2]にコンテナイメージをセットするだけで面倒なネットワーク周りの設定も簡略化でき、監視メディアを追加する際もリポジトリにプッシュするだけでコンテナの自動デプロイで簡単に増やすことができるので、運用が楽になると思ったのが採用理由になります。
:::message
EC2からECSへのDatadogエージェント移行は後日会社のテックブログに詳しい解説を掲載します。
:::

ただApp Runnerでメディアサーバーを外形監視すると奇妙なことがありました。
[^2]: https://aws.amazon.com/jp/ecr/

# レスポンスタイム劣化
App Runner上のDatadogエージェントから弊社のメディアサーバーに外形監視し、取得したレスポンスタイムのグラフ結果は以下のようになります。
![](/images/app-runner-proxy/image3.png)
*メディアサーバー毎のレスポンスタイム取得値*