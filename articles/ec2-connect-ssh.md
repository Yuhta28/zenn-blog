---
title: "ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰EC2 Instance Connectã‚’ä½¿ã£ã¦SSHæ¥ç¶šã—ã¦ã¿ã‚‹"
emoji: "ğŸ”“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws","ec2","ssh"]
published: true
---

# æ¦‚è¦
2023/6/13-14(ç¾åœ°æ™‚é–“)ã«ã‚¢ãƒ¡ãƒªã‚«ã‚¢ãƒŠãƒã‚¤ãƒ ã§é–‹å‚¬ã•ã‚ŒãŸ[AWS re:Inforce](https://reinforce.awsevents.com/)ã«ã¦EC2 Instance Connectã«æ–°ãŸãªæ©Ÿèƒ½ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸã€‚å¾“æ¥EC2 Instance Connectã§æ¥ç¶šã§ãã‚‹EC2ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‚‹ã‚‚ã®ã«é™ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚ã“ã®åº¦ç™ºè¡¨ã•ã‚ŒãŸEC2 Instance Connect Endpointã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒãŸãªã„EC2ã«å¯¾ã—ã¦ã‚‚SSH/RDPæ¥ç¶šãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã¾ãŸEC2 Instance Connectã¯ä»Šã¾ã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã§ã—ã‹æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€AWS CLIçµŒç”±ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ã‚‚æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã™ã§ã«EC2 Instance Connect Endpointã«ã¤ã„ã¦ç´¹ä»‹ã—ã¦ã„ã‚‹è¨˜äº‹ãŒã„ãã¤ã‹å­˜åœ¨ã—ã¦ã„ã¾ã™ãŒã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰æ¥ç¶šã§ãã‚‹ã“ã¨ã«ã¤ã„ã¦è¿°ã¹ãŸè¨˜äº‹ã¯ã¾ã å°‘ãªã‹ã£ãŸã®ã§AWS CLIã‚’ä½¿ç”¨ã—ã¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã®EC2ã«SSHæ¥ç¶šã—ãŸæ‰‹é †ã‚’ç´¹ä»‹ã„ãŸã—ã¾ã™ã€‚


# å¯¾è±¡èª­è€…
- EC2 Instance Connect Endpointã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„äºº
- SSHç§˜å¯†éµã®ç®¡ç†ãŒé¢å€’ã¨æ„Ÿã˜ã¦ã„ã‚‹äºº
- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½®ã•ã‚Œã¦ã„ã‚‹EC2ã«SSHæ¥ç¶šã—ãŸã„äºº

# ç›®æ¬¡
- [EC2 Instance Connectã«ã¤ã„ã¦](#ec2-instance-connectã«ã¤ã„ã¦)
- [AWS CLIçµŒç”±ã§SSHæ¥ç¶š](#aws-cliçµŒç”±ã§sshæ¥ç¶š)
- [æ‰€æ„Ÿ](#æ‰€æ„Ÿ)
- [å‚è€ƒæ–‡çŒ®](#å‚è€ƒæ–‡çŒ®)

# EC2 Instance Connectã«ã¤ã„ã¦
ã‚ã‚‰ãŸã‚ã¦EC2 Instance Connectã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã‹ã‚‰SSHç§˜å¯†éµãŒä¸è¦ã§IAMãƒ™ãƒ¼ã‚¹ã«ã‚ˆã‚‹èªè¨¼ã§EC2ã«SSHãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹æ¥ç¶šæ–¹å¼ã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã«ç§˜å¯†éµãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿ç®¡ã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç§˜å¯†éµã‚’æ¸¡ã™ã“ã¨ãªãEC2ã«å…¬é–‹éµèªè¨¼ãŒã§ãã‚‹ã®ã¯ä¾¿åˆ©ã§ã™ãŒã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½®ã•ã‚Œã¦ã„ã‚‹EC2ã®ã¿ã«ã—ã‹å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚
https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/Connect-using-EC2-Instance-Connect.html

ã‚‚ã—ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½®ã•ã‚Œã¦ã„ã‚‹EC2ã«ç§˜å¯†éµãªã—ã§SSHæ¥ç¶šã™ã‚‹å ´åˆã¯Systems Managerã®Session Managerã«ã‚ˆã‚‹æ¥ç¶šã§å®Ÿç¾ã§ãã¾ã™[^1]ãŒã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å‹ã®VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’3ã¤ä½œæˆã—ãªã‘ã‚Œã°ãªã‚‰ãšã€VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ–™é‡‘ãŒç´„$30/æœˆã»ã©ç™ºç”Ÿã—ã¾ã—ãŸã€‚[^2]
æ¤œè¨¼ç’°å¢ƒãªã©ã‚ã¾ã‚Šã‚³ã‚¹ãƒˆã‚’ã‹ã‘ãŸããªã„ç’°å¢ƒã§ã¯Session Managerã‚’ä½¿ã‚ãšè¸ã¿å°ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½®ã•ã‚Œã¦ã„ã‚‹EC2ã«æ¥ç¶šã™ã‚‹ã¨ã„ã†é‹ç”¨ã‚’ã¨ã‚‹äººã‚‚å¤šã‹ã£ãŸã¨æ€ã„ã¾ã™ã€‚

ãã“ã§ä»Šå›ç™ºè¡¨ã•ã‚ŒãŸEC2 Instance Connect Endpointã‚’ä½¿ã†ã“ã¨ã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½®ã•ã‚Œã¦ã„ã‚‹EC2ã«å¯¾ã—ã¦SSHæ¥ç¶šãŒå®Ÿç¾ã§ãã¾ã—ãŸã€‚VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æ–°ã—ãEC2 Instance Connectç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒç”¨æ„ã•ã‚Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµŒç”±ã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½®ã•ã‚Œã¦ã„ã‚‹EC2ã«æ¥ç¶šã§ãã¾ã™ã€‚
![](/images/ec2-connect-ssh/image1.png)
*AWSãƒ–ãƒ­ã‚°ã‚ˆã‚Šå¼•ç”¨[^3]*

ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å‹ã®VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã¯ç•°ãªã‚Šç„¡æ–™ã§åˆ©ç”¨ã§ãã¾ã™ã€‚
> There is no additional cost for using EIC endpoints. Standard data transfer charges apply.

https://aws.amazon.com/jp/about-aws/whats-new/2023/06/amazon-ec2-instance-connect-ssh-rdp-public-ip-address/

[^1]: https://dev.classmethod.jp/articles/tsnote-private-ec2-ssm-vpc-endpoint/
[^2]: æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³$0.014/hã§è¨ˆç®—
[^3]: https://aws.amazon.com/blogs/compute/secure-connectivity-from-public-to-private-introducing-ec2-instance-connect-endpoint-june-13-2023/

# AWS CLIçµŒç”±ã§SSHæ¥ç¶š
ä»Šå›ã®ä¸»é¡Œã¯AWS CLIçµŒç”±ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½®ã•ã‚Œã¦ã„ã‚‹EC2ã«å¯¾ã—ã¦SSHæ¥ç¶šã™ã‚‹ã“ã¨ã‚’ç›®æ¨™ã¨ã—ã¦ã„ã¾ã™ã€‚
ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰SSHæ¥ç¶šã™ã‚‹æ–¹æ³•ã«ã¤ãã¾ã—ã¦ã¯ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’ã”è¦§ãã ã•ã„ã€‚
https://dev.classmethod.jp/articles/ec2-instance-connect-endpoint-private-access/

äº‹å‰æº–å‚™ã¨ã—ã¦ã¯ä¸Šè¨˜è¨˜äº‹ã§ã‚‚æ›¸ã„ã¦ã‚ã‚‹ã¨ãŠã‚ŠEC2 Instance Connect Endpointç”¨ã®VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€EC2ã€VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å‰²ã‚Šå½“ã¦ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚‚ä½œæˆã—ã¾ã™ã€‚
## äº‹å‰æº–å‚™
- EC2 Instance Connect Endpoint
- SecurityGroup
    - EC2ç”¨
    - VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç”¨
- EC2
- AWS CLI


![](/images/ec2-connect-ssh/image2.png)
*ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ãŒEC2 Instance Connect*
![](/images/ec2-connect-ssh/image3.png)
*ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ãªã„*

```json:èµ·å‹•æ™‚ã«ã‚­ãƒ¼ãƒšã‚¢ã‚’å‰²ã‚Šå½“ã¦ã¦ã„ãªã„
[
    {
        "InstanceId": "i-0a0ea20774c13e3ea",
        "KeyName": null,
        "PrivateIpAddress": "10.0.12.187",
        "PublicIpAddress": null
    }
]
```

æº–å‚™ã§ãã¾ã—ãŸã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã‹ã‚‰ã“ã®EC2ã«å¯¾ã—ã¦SSHæ¥ç¶šã—ã¦ã¿ã¾ã™ã€‚

## å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
æ–°ã—ãã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸ[AWS CLIã‚³ãƒãƒ³ãƒ‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2-instance-connect/ssh.html)ã‚’ç¢ºèªã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã‹ã‚‰SSHæ¥ç¶šã§ãã¾ã™ã€‚

```teminal
$  aws ec2-instance-connect ssh --instance-id <instance-id>
```
## å®Ÿéš›ã®ã‚³ãƒãƒ³ãƒ‰çµæœ
![](/images/ec2-connect-ssh/image4.png)

SSHå…¬é–‹éµãŒãªã„ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½®ã•ã‚Œã¦ã„ã‚‹EC2ã«å¯¾ã—ã¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰SSHæ¥ç¶šã§ãã¾ã—ãŸã€‚

# æ‰€æ„Ÿ
AWS CLIçµŒç”±ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½®ã•ã‚Œã¦ã„ã‚‹EC2ã¸SSHæ¥ç¶šã—ã¾ã—ãŸã€‚
ã“ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã‚ˆã‚ŠSession Managerã‚ˆã‚Šã‚‚ç°¡å˜ã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã®EC2ã«SSHæ¥ç¶šãŒã§ãã‚‹ã®ã§å¬‰ã—ã„é™ã‚Šã§ã™ã€‚
ã¾ãŸå€‹äººçš„ã«è‰¯ã‹ã£ãŸç‚¹ã§ã™ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ¥ç¶šã—ãŸå ´åˆã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãªã©ã«ã‚³ãƒ”ãƒ¼ã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’`Ctrl+V`ã§ãƒšãƒ¼ã‚¹ãƒˆã§ããšã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è²¼ã‚Šä»˜ã‘ãªã„ã¨ãƒšãƒ¼ã‚¹ãƒˆã§ããªã‹ã£ãŸãŸåœ°å‘³ã«ã‚¹ãƒˆãƒ¬ã‚¹ã§ã—ãŸãŒã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãªã‚‰`Ctrl+V`ã‚­ãƒ¼ã§ã‚³ãƒãƒ³ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ãŒã§ãã‚‹ã®ãŒå¬‰ã—ã‹ã£ãŸã§ã™ã€‚
![](/images/ec2-connect-ssh/image5.png)
*ã“ã®è¡¨è¨˜ã«å…±æ„Ÿã—ã¦ãã‚Œã‚‹ã¯ãš*
ç°¡å˜ã«è©¦ã›ã¾ã™ã®ã§ãœã²ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰EC2 Instance Connect Endpointã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

# å‚è€ƒæ–‡çŒ®
https://dev.classmethod.jp/articles/demystifying-ec2-instance-connect-implementation/
https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html#SSH-using-EC2-Instance-Connect
https://aws.amazon.com/blogs/compute/secure-connectivity-from-public-to-private-introducing-ec2-instance-connect-endpoint-june-13-2023/
https://github.com/aws/aws-cli/pull/7971