---
title: "Slackãƒãƒ£ãƒ³ãƒãƒ«ã«EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè½ã¡ãŸã“ã¨ã‚’é€šçŸ¥ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ãŸ"
emoji: "ğŸ"
type: "tech"
topics: ["aws", "slack", "lambda"]
published: true
---

# èƒŒæ™¯
æ™‚æŠ˜ã€é–‹ç™ºç’°å¢ƒã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå‹æ‰‹ã«è½ã¡ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã€æ°—ãŒä»˜ã„ãŸäººã‹ã‚‰ã®å•ã„åˆã‚ã›ã§ãã®éƒ½åº¦æ‰‹å‹•ã§EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†èµ·å‹•ã—ã¦ã„ã¾ã—ãŸã€‚
é–‹ç™ºè€…é”ãŒé–‹ç™ºã«é›†ä¸­ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«è‡ªå‹•ã§é€šçŸ¥ã—ã¦ãã‚Œã‚‹ã‚ˆã†ãªä»•çµ„ã¿ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚
# å®Ÿè£…ä¸€è¦§
- Slackãƒãƒ£ãƒ³ãƒãƒ«ã«EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒstoppedã«ãªã£ãŸã“ã¨ã‚’é€šçŸ¥ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- stoppedã«ãªã£ãŸã‚‰ã€è‡ªå‹•ã§å†èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- ä¸Šè¨˜ã®æ©Ÿèƒ½ã‚’9:00~21:00ã®é–“ã«é™å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

9:00~21:00ã®é–“ã«åˆ¶é™ã‚’è¨­ã‘ã¦ã„ã‚‹ç†ç”±ã§ã™ãŒã€é–‹ç™ºç’°å¢ƒã§ã¯ã‚³ã‚¹ãƒˆæ”¹å–„ã®ãŸã‚ã«21æ™‚ã«ãªã£ãŸã‚‰ã€è‡ªå‹•ã§é–‹ç™ºç’°å¢ƒã®ã™ã¹ã¦ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒshutdownã•ã‚Œã€ç¿Œæœ9æ™‚ã«ãªã£ãŸã‚‰è‡ªå‹•ã§èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚
ãªã®ã§ã€ä»®ã«ä¸Šè¨˜ã®æ©Ÿèƒ½ãŒ21æ™‚ä»¥é™ã‚‚æœ‰åŠ¹ã«ãªã£ã¦ã—ã¾ã†ã¨ã€å¹¾ã¤ã‚‚ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥ãŒSlackãƒãƒ£ãƒ³ãƒãƒ«ã‚’åŸ‹ã‚ã‚‹ã ã‘ã§ãªãã€æ·±å¤œæ—©æœå¸¯ã‚‚é–‹ç™ºç’°å¢ƒãŒèµ·å‹•ã•ã‚Œç¶šã‘ã‚‹ã¨ã„ã†æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚
### ä½¿ç”¨ãƒ„ãƒ¼ãƒ«
- CloudWatch Event
- Lambda
- Incoming Webhook

# æ‰‹é †
#### Slackã‹ã‚‰Incoming Webhookã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
ä½•ã‹ã—ã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’Slackã®ãƒãƒ£ãƒ³ãƒãƒ«ã«é€šçŸ¥ã™ã‚‹ãŸã‚ã«ã¯Incoming Webhookã¨ã„ã†Slackã‚¢ãƒ—ãƒªã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§å®Ÿç¾å¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚
https://slack.com/intl/ja-jp/help/articles/115005265063-Slack-%E3%81%A7%E3%81%AE-Incoming-Webhook-%E3%81%AE%E5%88%A9%E7%94%A8
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’å…±æœ‰ã—ãŸã„Slackãƒãƒ£ãƒ³ãƒãƒ«ã‚’é¸æŠã—ã€WebhookURLã‚’æ§ãˆã¦ãŠãã¾ã™ã€‚
![](/images/slack-ec2/image1.png)
#### Lambdaé–¢æ•°ã‚’ä½œæˆã™ã‚‹
æ–°è¦ã§Lambdaé–¢æ•°ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®é–¢æ•°ã‚’æ›¸ãã¾ã™ã€‚
![](/images/slack-ec2/image2.png)

```python:lambda_function.py
from __future__ import print_function
from time import strptime, strftime

import os, json, boto3, urllib.request

#GMTè¡¨è¨˜
before = strptime('00:00:00', '%H:%M:%S')
after = strptime('11:59:00', '%H:%M:%S')
now = strptime(strftime('%H:%M:%S'), '%H:%M:%S')

print(now)

#è‡ªå‹•èµ·å‹•/ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãƒãƒƒãƒã«å¼•ã£ã‹ã‹ã‚‰ãªã„ã‚ˆã†ã«JST9:00-JST21:00ã®é–“ã§å‡¦ç†ã‚’å‹•ã‹ã™ã‚ˆã†ã«ã—ã¦ã„ã‚‹
if (now >= before and now <= after):

   #å¤‰æ•°eventã®ä¸­èº«ãŒCloudWatch Eventã‹ã‚‰å—ã‘å–ã£ãŸEC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®stop
   def lambda_handler(event,context):
      
      instances = [ event ]
      region = 'ap-northeast-1'
      ec2 = boto3.client('ec2', region_name=region)
      
      #è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç™ºè¡Œ
      attachments = {
        'attachments': [{
          # titleã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨title_linkã§è¨­å®šã—ãŸãƒšãƒ¼ã‚¸ã¸é£›ã³ã¾ã™ã€‚
          'title': 'EC2ãŒåœæ­¢ã—ã¾ã—ãŸã€‚',
          'title_link': 'https://api.slack.com/docs/message-attachments',
          'color': "warning",
        }]
      }
      
      req = json.dumps(attachments).encode('ascii')
      
      message_color = urllib.request.Request(os.environ['slackUrl'], req )
      
      try:
         response = urllib.request.urlopen(message_color)
         response.read()

      except Exception as e:
         print(e)
   
      #ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®èµ·å‹•åœæ­¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      message_stop = {
         'text': "<!here> EC2 Instance " + (event) + " stopped"
      }

      data = json.dumps(message_stop).encode('ascii')
   
      req = urllib.request.Request(os.environ['slackUrl'], data )
      try:
          response = urllib.request.urlopen(req)
          response.read()
       
          print("Message posted: %s" % message_stop )
      except Exception as e:
          print(e)

      #åœæ­¢ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å†èµ·å‹•
      ec2.start_instances(InstanceIds=instances)
      message_restart = {
         'text': "started your instances: " + str(instances)
      }
      
      data2 = json.dumps(message_restart).encode('ascii')
      
      req = urllib.request.Request(os.environ['slackUrl'], data2 )
      try:
          response = urllib.request.urlopen(req)
          response.read()
       
          print("Message posted: %s" % message_restart )
      except Exception as e:
          print(e)
          
   #è‡ªå‹•èµ·å‹•/ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãŒèµ°ã‚‹9æ™‚å‰ã€21æ™‚ä»¥é™ã¯å‡¦ç†ã‚’ã•ã›ãªã„
else:
   print("out time of function")

```
é–¢æ•°å†…ã§æœªå®šç¾©ã®å¤‰æ•°slackUrlã¯Lambdaå´ã‹ã‚‰å–å¾—ã—ãŸWebhookURLã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚
![](/images/slack-ec2/image3.png)

#### CloudWatch Eventã§Lambdaé–¢æ•°ãŒç™ºå‹•ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹
EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒstoppedã«ãªã£ãŸã‚‰å…ˆã»ã©ä½œæˆã—ãŸLambdaé–¢æ•°ã‚’èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
![](/images/slack-ec2/image4.png)
ã“ã®æ™‚ã€Lambdaé–¢æ•°ã¸æ¸¡ã™å…¥åŠ›å†…å®¹ã‚’çµã‚‹ã“ã¨ã§Slackãƒãƒ£ãƒ³ãƒãƒ«ã«è¡¨ç¤ºã•ã‚Œã‚‹å†…å®¹ã‚’è¦‹ã‚„ã™ã„ã‚‚ã®ã«åŠ å·¥ã§ãã¾ã™ã€‚
â€»å…¨è¡¨ç¤ºã®å ´åˆ(ä¸€éƒ¨ãƒ¢ã‚¶ã‚¤ã‚¯å‡¦ç†)
![](/images/slack-ec2/image5.png)
ä»¥ä¸Šã§ã€Slackãƒãƒ£ãƒ³ãƒãƒ«ã¸é€šçŸ¥ã™ã‚‹æ‰‹é †ã¯å®Œäº†ã—ã¾ã—ãŸã€‚æœ€å¾Œã«EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢ã•ã›ã¦ã€Slackãƒãƒ£ãƒ³ãƒãƒ«ã¸é€šçŸ¥ãŒå±Šãã€å†èµ·å‹•ãŒã§ãã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
![](/images/slack-ec2/image6.png)
ã¡ã‚ƒã‚“ã¨å®Ÿè£…ã—ãŸã‹ã£ãŸã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
# æ‰€æ„Ÿ
AWSã¨Slackã®é€£æºæ–¹æ³•ã¨ã—ã¦ã€CloudWatch Alarmã‹ã‚‰Lambdaã‚’é£›ã°ã—ã¦Slackãƒãƒ£ãƒ³ãƒãƒ«ã¸ã‚¢ãƒ©ãƒ¼ãƒ å†…å®¹ã‚’é€£æºã™ã‚‹æ–¹æ³•ãŒä¸€èˆ¬çš„ã§ã€æ¤œç´¢ã™ã‚‹ã¨å¤šãã®è¨˜äº‹ãŒå‡ºã¦ãã¦Lambdaé–¢æ•°ã«ã‚‚ãã‚Œç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚
ã¾ãŸã€æœ€è¿‘AWSã¨SlackãŒã€ææºã‚’ç™ºè¡¨ã—ãã‚Œãã‚Œã®ã‚µãƒ¼ãƒ“ã‚¹ã®çµã³ã¤ããŒä»Šå¾Œã¾ã™ã¾ã™å¼·ããªã£ã¦ã„ãã¨æ€ã‚ã‚Œã¾ã™ã€‚
https://www.itmedia.co.jp/news/articles/2006/05/news065.html

æœ€è¿‘ã§ã™ã¨ã€AWS Chatbotã§ç°¡å˜ã«AWSã‚µãƒ¼ãƒ“ã‚¹ã®å†…å®¹ã‚’Slackã¸é€£æºã—ã‚„ã™ããªã‚Šã¾ã—ãŸãŒã€ã¾ã æä¾›ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒå°‘ãªã„ãŸã‚CloudWatch Eventã§ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã‚‰æ¤œè¨¼ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# 2021å¹´12æœˆ25æ—¥è¿½è¨˜
AWS Chatbotã®æ©Ÿèƒ½ã‚‚å¤§åˆ†å¢—ãˆã¦ã„ãAmazon EventBridgeã‚’ä½¿ã£ã¦Slackã¸é€£æºã—ãŸã»ã†ãŒç°¡å˜ã«é€šçŸ¥ã§ããã†ã§ã™ã€‚
https://zenn.dev/yuta28/articles/eventbridge-slack

# LTè³‡æ–™
ã“ã®è¨˜äº‹ã‚’åŸºã«ã—ã¦LTã‚’è¡Œãªã„ã¾ã—ãŸã®ã§è³‡æ–™ã‚’ç½®ã„ã¦ãŠãã¾ã™ã€‚
@[speakerdeck](919ac08d0b5c4138b5a32e61248ac6b5)